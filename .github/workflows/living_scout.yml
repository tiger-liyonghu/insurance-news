name: GIFIA Living Scout - 24/7 全球自动侦察

on:
  schedule:
    # 每30分钟执行一次（热点搜索）
    - cron: '*/30 * * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  scout:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip list | grep -E "(tavily|supabase|google-generativeai|openai)"
    
    - name: Verify environment variables
      env:
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "Checking environment variables..."
        if [ -z "$TAVILY_API_KEY" ]; then echo "⚠️ TAVILY_API_KEY is not set"; fi
        if [ -z "$GEMINI_API_KEY" ]; then echo "⚠️ GEMINI_API_KEY is not set"; fi
        if [ -z "$SUPABASE_URL" ]; then echo "⚠️ SUPABASE_URL is not set"; fi
        if [ -z "$SUPABASE_KEY" ]; then echo "⚠️ SUPABASE_KEY is not set"; fi
        if [ -n "$TAVILY_API_KEY" ] && [ -n "$GEMINI_API_KEY" ] && [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
          echo "✅ All required environment variables are set"
        fi
    
    - name: Run diagnostic script
      env:
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        python3 test_github_actions.py
        DIAG_EXIT_CODE=$?
        if [ $DIAG_EXIT_CODE -eq 1 ]; then
          echo "⚠️ 诊断脚本发现错误，但继续执行主脚本..."
          echo "请查看上方输出了解详情"
        fi
        # 不因为诊断脚本的错误而停止，让主脚本自己处理
    
    - name: Run Living Scout
      env:
        TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        set -e  # 遇到错误立即退出
        python3 agent_v4_living_scout.py
    
    - name: Report results
      if: always()
      run: |
        echo "✅ Living Scout 执行完成"
        echo "时间: $(date)"
