<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿é™©æ–°é—»çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .news-card {
            transition: all 0.3s ease;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .countdown {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- API Keys é…ç½® -->
    <script>
        // ========== API é…ç½® ==========
        const NEWS_API_KEY = '4fdac0034c824cbcbc6b87d8aba55a21'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„ NewsAPI Key
        const GEMINI_API_KEY = 'AIzaSyCue2ll9tnKu2JlY8oRUJJzAKyRvuY4Zfw'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„ Gemini API Key
        
        // CORS ä»£ç†æœåŠ¡ï¼ˆNewsAPI ä¸å…è®¸ä»æµè§ˆå™¨ç›´æ¥è°ƒç”¨ï¼Œå¿…é¡»ä½¿ç”¨ä»£ç†ï¼‰
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const USE_PROXY = true; // NewsAPI éœ€è¦ä»£ç†æ‰èƒ½ä»æµè§ˆå™¨è°ƒç”¨
    </script>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white tracking-tight">ä¿é™©æ–°é—»çœ‹æ¿</h1>
                    <span class="ml-4 text-xs text-gray-400 font-mono">Insurance News Dashboard</span>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">ä¸‹æ¬¡æ›´æ–°ï¼š</span>
                        <span id="countdown" class="countdown text-lg font-semibold text-blue-400">120</span>
                        <span class="text-sm text-gray-400">ç§’</span>
                    </div>
                    <button 
                        id="refreshBtn" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                    >
                        ç«‹å³åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-400">æ­£åœ¨åŠ è½½æ–°é—»...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error" class="hidden bg-red-900/30 border border-red-700 rounded-lg p-4 mb-6">
            <p class="text-red-300" id="errorMessage"></p>
        </div>

        <!-- æ–°é—»åˆ—è¡¨ -->
        <div id="newsContainer" class="hidden space-y-4">
            <!-- æ–°é—»å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </main>

    <script>
        let countdownInterval = null;
        let updateInterval = null;
        let countdownSeconds = 120;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
            setupRefreshButton();
        });

        // è®¾ç½®åˆ·æ–°æŒ‰é’®
        function setupRefreshButton() {
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadNews();
            });
        }

        // å¯åŠ¨å€’è®¡æ—¶
        function startCountdown() {
            countdownSeconds = 120;
            const countdownEl = document.getElementById('countdown');
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                countdownEl.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    loadNews();
                }
            }, 1000);
        }

        // è·å–æ–°é—»æ•°æ®
        async function loadNews() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const errorMessageEl = document.getElementById('errorMessage');
            const newsContainer = document.getElementById('newsContainer');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            newsContainer.classList.add('hidden');

            try {
                // æ„å»º NewsAPI URL
                const keywords = ['Insurance', 'Insurtech', 'Reinsurance'];
                const query = keywords.join(' OR ');
                let newsApiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=en&sortBy=publishedAt&pageSize=10&apiKey=${NEWS_API_KEY}`;
                
                // å¦‚æœéœ€è¦ä½¿ç”¨ä»£ç†
                if (USE_PROXY) {
                    newsApiUrl = CORS_PROXY + encodeURIComponent(newsApiUrl);
                }

                // è·å–æ–°é—»
                const response = await fetch(newsApiUrl);
                
                if (!response.ok) {
                    // å°è¯•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    let errorDetail = '';
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.message || errorData.code || '';
                    } catch (e) {
                        errorDetail = response.statusText;
                    }
                    
                    if (response.status === 401) {
                        throw new Error(`API Key æ— æ•ˆæˆ–æœªæˆæƒã€‚è¯·æ£€æŸ¥æ‚¨çš„ NewsAPI Key æ˜¯å¦æ­£ç¡®ã€‚é”™è¯¯è¯¦æƒ…: ${errorDetail}`);
                    } else if (response.status === 429) {
                        throw new Error('API è¯·æ±‚æ¬¡æ•°è¶…é™ï¼Œè¯·ç¨åå†è¯•');
                    } else {
                        throw new Error(`NewsAPI é”™è¯¯ (${response.status}): ${errorDetail || response.statusText}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.status === 'error') {
                    throw new Error(`NewsAPI è¿”å›é”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                if (data.status !== 'ok' || !data.articles || data.articles.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°ç›¸å…³æ–°é—»');
                }

                // å¤„ç†æ–°é—»æ•°æ®
                const articles = data.articles.slice(0, 10);
                
                // ä½¿ç”¨ Gemini API å¤„ç†æ¯æ¡æ–°é—»
                const processedArticles = await Promise.all(
                    articles.map(article => processArticleWithGemini(article))
                );

                // æ¸²æŸ“æ–°é—»
                renderNews(processedArticles);
                
                // å¯åŠ¨å€’è®¡æ—¶
                startCountdown();
                
            } catch (error) {
                console.error('åŠ è½½æ–°é—»å¤±è´¥:', error);
                errorMessageEl.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                errorEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // ä½¿ç”¨ Gemini API å¤„ç†æ–‡ç« ï¼ˆç¿»è¯‘å’Œç”Ÿæˆç‚¹è¯„ï¼‰
        async function processArticleWithGemini(article) {
            try {
                const prompt = `è¯·å°†ä»¥ä¸‹è‹±æ–‡æ–°é—»æ ‡é¢˜å’Œæ‘˜è¦ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶ä¸ºè¿™æ¡æ–°é—»ç”Ÿæˆä¸€å¥ç®€çŸ­çš„ä¸­æ–‡ç‚¹è¯„ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ã€‚

æ ‡é¢˜: ${article.title || 'æ— æ ‡é¢˜'}
æ‘˜è¦: ${article.description || 'æ— æ‘˜è¦'}

è¯·ä»¥ JSON æ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "title_zh": "ä¸­æ–‡æ ‡é¢˜",
  "description_zh": "ä¸­æ–‡æ‘˜è¦",
  "comment": "ä¸€å¥è¯ç‚¹è¯„"
}`;

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API é”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Gemini API è¿”å›æ ¼å¼é”™è¯¯');
                }

                const text = data.candidates[0].content.parts[0].text;
                
                // å°è¯•æå– JSONï¼ˆGemini å¯èƒ½è¿”å›å¸¦ markdown æ ¼å¼çš„æ–‡æœ¬ï¼‰
                let jsonText = text.trim();
                if (jsonText.includes('```json')) {
                    jsonText = jsonText.split('```json')[1].split('```')[0].trim();
                } else if (jsonText.includes('```')) {
                    jsonText = jsonText.split('```')[1].split('```')[0].trim();
                }
                
                const result = JSON.parse(jsonText);
                
                return {
                    ...article,
                    title_zh: result.title_zh || article.title,
                    description_zh: result.description_zh || article.description,
                    comment: result.comment || 'æš‚æ— ç‚¹è¯„'
                };
                
            } catch (error) {
                console.error('Gemini API å¤„ç†å¤±è´¥:', error);
                // å¦‚æœ Gemini API å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                return {
                    ...article,
                    title_zh: article.title,
                    description_zh: article.description,
                    comment: 'AI å¤„ç†å¤±è´¥ï¼Œæ˜¾ç¤ºåŸæ–‡'
                };
            }
        }

        // æ¸²æŸ“æ–°é—»åˆ—è¡¨
        function renderNews(articles) {
            const newsContainer = document.getElementById('newsContainer');
            newsContainer.innerHTML = '';

            articles.forEach((article, index) => {
                const card = document.createElement('div');
                card.className = 'news-card bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-blue-500';
                
                const publishedDate = article.publishedAt 
                    ? new Date(article.publishedAt).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : 'æœªçŸ¥æ—¶é—´';

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h2 class="text-xl font-semibold text-white mb-2 leading-tight">
                                ${article.title_zh || article.title}
                            </h2>
                            <p class="text-gray-400 text-sm mb-3 line-clamp-2">
                                ${article.description_zh || article.description || 'æš‚æ— æ‘˜è¦'}
                            </p>
                        </div>
                        ${article.urlToImage ? `
                            <img src="${article.urlToImage}" 
                                 alt="${article.title_zh || article.title}" 
                                 class="ml-4 w-24 h-24 object-cover rounded-lg flex-shrink-0"
                                 onerror="this.style.display='none'">
                        ` : ''}
                    </div>
                    
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>${article.source?.name || 'æœªçŸ¥æ¥æº'}</span>
                            <span>â€¢</span>
                            <span>${publishedDate}</span>
                        </div>
                        ${article.url ? `
                            <a href="${article.url}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                                é˜…è¯»åŸæ–‡ â†’
                            </a>
                        ` : ''}
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <div class="flex items-start">
                            <span class="text-blue-400 text-sm font-medium mr-2">ğŸ’¡ ç‚¹è¯„ï¼š</span>
                            <p class="text-gray-300 text-sm flex-1">${article.comment || 'æš‚æ— ç‚¹è¯„'}</p>
                        </div>
                    </div>
                `;
                
                newsContainer.appendChild(card);
            });

            newsContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
